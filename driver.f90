program driver

use fv3geom_constants_mod, only: pi
use fv3geom_create_grid_mod, only: create_fv3_grid

implicit none

integer              :: grid_type
integer              :: npx
integer              :: npy
integer              :: ng = 0
integer              :: isc, iec, jsc, jec, tile
real(8), allocatable :: lat(:,:)
real(8), allocatable :: lon(:,:)
real(8)              :: shift_fac_in = 0.0_8

integer :: i, j, n
character(len=6) :: grid_type_name(3)
real(8), allocatable :: latref(:,:)
real(8), allocatable :: lonref(:,:)

grid_type_name(1) = " EDFV3"
grid_type_name(2) = " EDIST"
grid_type_name(3) = " EANGU"

tile = 1

print*, ''

do npx = 13, 13 !5

  print*, 'NPX:', npx
  print*, ''

  npy = npx
  isc = 1
  iec = npx - 1
  jsc = 1
  jec = npy - 1

  allocate(lat(isc:iec+1,jsc:jec+1))
  allocate(lon(isc:iec+1,jsc:jec+1))
  allocate(latref(isc:iec+1,jsc:jec+1))
  allocate(lonref(isc:iec+1,jsc:jec+1))

  do n = 0, 2 ! 2

    call create_fv3_grid(n, npx, npy, ng, isc, iec, jsc, jec, tile, lat, lon, shift_fac_in)

    do j = jsc, jec+1
      do i = isc, iec+1
        if (lon(i,j) > pi) then
          lon(i,j) = -2*pi + lon(i,j)
        endif
      enddo
    enddo

    print*, grid_type_name(n+1)

    call get_ref(n, npx, latref, lonref)

    if (maxval(abs(latref-lat)) > 1.0e-16_8 .or. maxval(abs(lonref-lon)) > 1.0e-16_8) then

      print*, ' FAIL', maxval(abs(latref-lat)), maxval(abs(lonref-lon))
      do i = 1,npx
        print*, real(lat(:,i),8)
      enddo
      print*, ''
      do i = 1,npx
        print*, real(lon(:,i),8)
      enddo

    else
      print*, ' PASS'
    endif

    print*, ''

!    do j = jsc, jec+1
!      do i = isc, iec+1
!        print*, 'lat(',i,',',j,') = ', lat(i,j)
!        print*, 'lon(',i,',',j,') = ', lon(i,j)
!      enddo
!    enddo

  enddo

  deallocate(lat)
  deallocate(lon)
  deallocate(latref)
  deallocate(lonref)

enddo

contains

subroutine get_ref(grid_type, npx, lat, lon)

integer, intent(in)  :: grid_type
integer, intent(in)  :: npx
real(8), intent(out) :: lat(:,:)
real(8), intent(out) :: lon(:,:)

if (grid_type == 0 .and. npx == 5) then

  lat(           1 ,           1 ) =  -0.61547970867038748_8
  lon(           1 ,           1 ) =  -0.78539816339744828_8
  lat(           2 ,           1 ) =  -0.73945769686140406_8
  lon(           2 ,           1 ) =  -0.42242951479180757_8
  lat(           3 ,           1 ) =  -0.78539816339744828_8
  lon(           3 ,           1 ) =    0.0000000000000000_8
  lat(           4 ,           1 ) =  -0.73945769686140406_8
  lon(           4 ,           1 ) =   0.42242951479180757_8
  lat(           5 ,           1 ) =  -0.61547970867038748_8
  lon(           5 ,           1 ) =   0.78539816339744828_8
  lat(           1 ,           2 ) =  -0.30773985433519385_8
  lon(           1 ,           2 ) =  -0.78539816339744828_8
  lat(           2 ,           2 ) =  -0.38907806349854779_8
  lon(           2 ,           2 ) =  -0.42242951479180757_8
  lat(           3 ,           2 ) =  -0.42242951479180785_8
  lon(           3 ,           2 ) =    0.0000000000000000_8
  lat(           4 ,           2 ) =  -0.38907806349854779_8
  lon(           4 ,           2 ) =   0.42242951479180757_8
  lat(           5 ,           2 ) =  -0.30773985433519385_8
  lon(           5 ,           2 ) =   0.78539816339744828_8
  lat(           1 ,           3 ) =    0.0000000000000000_8
  lon(           1 ,           3 ) =  -0.78539816339744828_8
  lat(           2 ,           3 ) =    0.0000000000000000_8
  lon(           2 ,           3 ) =  -0.42242951479180757_8
  lat(           3 ,           3 ) =    0.0000000000000000_8
  lon(           3 ,           3 ) =    0.0000000000000000_8
  lat(           4 ,           3 ) =    0.0000000000000000_8
  lon(           4 ,           3 ) =   0.42242951479180757_8
  lat(           5 ,           3 ) =    0.0000000000000000_8
  lon(           5 ,           3 ) =   0.78539816339744828_8
  lat(           1 ,           4 ) =   0.30773985433519385_8
  lon(           1 ,           4 ) =  -0.78539816339744828_8
  lat(           2 ,           4 ) =   0.38907806349854779_8
  lon(           2 ,           4 ) =  -0.42242951479180757_8
  lat(           3 ,           4 ) =   0.42242951479180785_8
  lon(           3 ,           4 ) =    0.0000000000000000_8
  lat(           4 ,           4 ) =   0.38907806349854779_8
  lon(           4 ,           4 ) =   0.42242951479180757_8
  lat(           5 ,           4 ) =   0.30773985433519385_8
  lon(           5 ,           4 ) =   0.78539816339744828_8
  lat(           1 ,           5 ) =   0.61547970867038748_8
  lon(           1 ,           5 ) =  -0.78539816339744828_8
  lat(           2 ,           5 ) =   0.73945769686140406_8
  lon(           2 ,           5 ) =  -0.42242951479180757_8
  lat(           3 ,           5 ) =   0.78539816339744828_8
  lon(           3 ,           5 ) =    0.0000000000000000_8
  lat(           4 ,           5 ) =   0.73945769686140406_8
  lon(           4 ,           5 ) =   0.42242951479180757_8
  lat(           5 ,           5 ) =   0.61547970867038748_8
  lon(           5 ,           5 ) =   0.78539816339744828_8

elseif (grid_type == 0 .and. npx == 4) then

  lat(           1 ,           1 ) =  -0.61547970867038748_8
  lon(           1 ,           1 ) =  -0.78539816339744828_8
  lat(           2 ,           1 ) =  -0.76464052580534680_8
  lon(           2 ,           1 ) =  -0.28620119346614459_8
  lat(           3 ,           1 ) =  -0.76464052580534680_8
  lon(           3 ,           1 ) =   0.28620119346614414_8
  lat(           4 ,           1 ) =  -0.61547970867038748_8
  lon(           4 ,           1 ) =   0.78539816339744828_8
  lat(           1 ,           2 ) =  -0.20515990289012920_8
  lon(           1 ,           2 ) =  -0.78539816339744828_8
  lat(           2 ,           2 ) =  -0.27514946655264505_8
  lon(           2 ,           2 ) =  -0.28620119346614459_8
  lat(           3 ,           2 ) =  -0.27514946655264505_8
  lon(           3 ,           2 ) =   0.28620119346614414_8
  lat(           4 ,           2 ) =  -0.20515990289012920_8
  lon(           4 ,           2 ) =   0.78539816339744828_8
  lat(           1 ,           3 ) =   0.20515990289012920_8
  lon(           1 ,           3 ) =  -0.78539816339744828_8
  lat(           2 ,           3 ) =   0.27514946655264505_8
  lon(           2 ,           3 ) =  -0.28620119346614459_8
  lat(           3 ,           3 ) =   0.27514946655264505_8
  lon(           3 ,           3 ) =   0.28620119346614414_8
  lat(           4 ,           3 ) =   0.20515990289012920_8
  lon(           4 ,           3 ) =   0.78539816339744828_8
  lat(           1 ,           4 ) =   0.61547970867038748_8
  lon(           1 ,           4 ) =  -0.78539816339744828_8
  lat(           2 ,           4 ) =   0.76464052580534680_8
  lon(           2 ,           4 ) =  -0.28620119346614459_8
  lat(           3 ,           4 ) =   0.76464052580534680_8
  lon(           3 ,           4 ) =   0.28620119346614414_8
  lat(           4 ,           4 ) =   0.61547970867038748_8
  lon(           4 ,           4 ) =   0.78539816339744828_8

elseif (grid_type == 1 .and. npx == 5) then

  lat(           1 ,           1 ) =  -0.61547970867038748_8
  lon(           1 ,           1 ) =  -0.78539816339744828_8
  lat(           2 ,           1 ) =  -0.72972765622696634_8
  lon(           2 ,           1 ) =  -0.46364760900080615_8
  lat(           3 ,           1 ) =  -0.78539816339744839_8
  lon(           3 ,           1 ) =    0.0000000000000000_8
  lat(           4 ,           1 ) =  -0.72972765622696634_8
  lon(           4 ,           1 ) =   0.46364760900080615_8
  lat(           5 ,           1 ) =  -0.61547970867038748_8
  lon(           5 ,           1 ) =   0.78539816339744828_8
  lat(           1 ,           2 ) =  -0.33983690945412198_8
  lon(           1 ,           2 ) =  -0.78539816339744828_8
  lat(           2 ,           2 ) =  -0.42053433528396517_8
  lon(           2 ,           2 ) =  -0.46364760900080615_8
  lat(           3 ,           2 ) =  -0.46364760900080615_8
  lon(           3 ,           2 ) =    0.0000000000000000_8
  lat(           4 ,           2 ) =  -0.42053433528396517_8
  lon(           4 ,           2 ) =   0.46364760900080615_8
  lat(           5 ,           2 ) =  -0.33983690945412198_8
  lon(           5 ,           2 ) =   0.78539816339744828_8
  lat(           1 ,           3 ) =    0.0000000000000000_8
  lon(           1 ,           3 ) =  -0.78539816339744828_8
  lat(           2 ,           3 ) =    0.0000000000000000_8
  lon(           2 ,           3 ) =  -0.46364760900080615_8
  lat(           3 ,           3 ) =    0.0000000000000000_8
  lon(           3 ,           3 ) =    0.0000000000000000_8
  lat(           4 ,           3 ) =    0.0000000000000000_8
  lon(           4 ,           3 ) =   0.46364760900080615_8
  lat(           5 ,           3 ) =    0.0000000000000000_8
  lon(           5 ,           3 ) =   0.78539816339744828_8
  lat(           1 ,           4 ) =   0.33983690945412198_8
  lon(           1 ,           4 ) =  -0.78539816339744828_8
  lat(           2 ,           4 ) =   0.42053433528396517_8
  lon(           2 ,           4 ) =  -0.46364760900080615_8
  lat(           3 ,           4 ) =   0.46364760900080615_8
  lon(           3 ,           4 ) =    0.0000000000000000_8
  lat(           4 ,           4 ) =   0.42053433528396517_8
  lon(           4 ,           4 ) =   0.46364760900080615_8
  lat(           5 ,           4 ) =   0.33983690945412198_8
  lon(           5 ,           4 ) =   0.78539816339744828_8
  lat(           1 ,           5 ) =   0.61547970867038748_8
  lon(           1 ,           5 ) =  -0.78539816339744828_8
  lat(           2 ,           5 ) =   0.72972765622696634_8
  lon(           2 ,           5 ) =  -0.46364760900080615_8
  lat(           3 ,           5 ) =   0.78539816339744839_8
  lon(           3 ,           5 ) =    0.0000000000000000_8
  lat(           4 ,           5 ) =   0.72972765622696634_8
  lon(           4 ,           5 ) =   0.46364760900080615_8
  lat(           5 ,           5 ) =   0.61547970867038748_8
  lon(           5 ,           5 ) =   0.78539816339744828_8

elseif (grid_type == 1 .and. npx == 4) then

  lat(           1 ,           1 ) =  -0.61547970867038748_8
  lon(           1 ,           1 ) =  -0.78539816339744828_8
  lat(           2 ,           1 ) =  -0.75907020926666335_8
  lon(           2 ,           1 ) =  -0.32175055439664213_8
  lat(           3 ,           1 ) =  -0.75907020926666335_8
  lon(           3 ,           1 ) =   0.32175055439664213_8
  lat(           4 ,           1 ) =  -0.61547970867038748_8
  lon(           4 ,           1 ) =   0.78539816339744828_8
  lat(           1 ,           2 ) =  -0.23147736397017837_8
  lon(           1 ,           2 ) =  -0.78539816339744828_8
  lat(           2 ,           2 ) =  -0.30627736916966947_8
  lon(           2 ,           2 ) =  -0.32175055439664213_8
  lat(           3 ,           2 ) =  -0.30627736916966947_8
  lon(           3 ,           2 ) =   0.32175055439664213_8
  lat(           4 ,           2 ) =  -0.23147736397017837_8
  lon(           4 ,           2 ) =   0.78539816339744828_8
  lat(           1 ,           3 ) =   0.23147736397017837_8
  lon(           1 ,           3 ) =  -0.78539816339744828_8
  lat(           2 ,           3 ) =   0.30627736916966947_8
  lon(           2 ,           3 ) =  -0.32175055439664213_8
  lat(           3 ,           3 ) =   0.30627736916966947_8
  lon(           3 ,           3 ) =   0.32175055439664213_8
  lat(           4 ,           3 ) =   0.23147736397017837_8
  lon(           4 ,           3 ) =   0.78539816339744828_8
  lat(           1 ,           4 ) =   0.61547970867038748_8
  lon(           1 ,           4 ) =  -0.78539816339744828_8
  lat(           2 ,           4 ) =   0.75907020926666335_8
  lon(           2 ,           4 ) =  -0.32175055439664213_8
  lat(           3 ,           4 ) =   0.75907020926666335_8
  lon(           3 ,           4 ) =   0.32175055439664213_8
  lat(           4 ,           4 ) =   0.61547970867038748_8
  lon(           4 ,           4 ) =   0.78539816339744828_8

elseif (grid_type == 2 .and. npx == 5) then

  lat(           1 ,           1 ) =  -0.61547970867038726_8
  lon(           1 ,           1 ) =  -0.78539816339744828_8
  lat(           2 ,           1 ) =  -0.74585266077307355_8
  lon(           2 ,           1 ) =  -0.39269908169872458_8
  lat(           3 ,           1 ) =  -0.78539816339744817_8
  lon(           3 ,           1 ) =    0.0000000000000000_8
  lat(           4 ,           1 ) =  -0.74585266077307355_8
  lon(           4 ,           1 ) =   0.39269908169872414_8
  lat(           5 ,           1 ) =  -0.61547970867038726_8
  lon(           5 ,           1 ) =   0.78539816339744828_8
  lat(           1 ,           2 ) =  -0.28492412662206240_8
  lon(           1 ,           2 ) =  -0.78539816339744739_8
  lat(           2 ,           2 ) =  -0.36548975596819283_8
  lon(           2 ,           2 ) =  -0.39269908169872458_8
  lat(           3 ,           2 ) =  -0.39269908169872420_8
  lon(           3 ,           2 ) =    0.0000000000000000_8
  lat(           4 ,           2 ) =  -0.36548975596819283_8
  lon(           4 ,           2 ) =   0.39269908169872414_8
  lat(           5 ,           2 ) =  -0.28492412662206240_8
  lon(           5 ,           2 ) =   0.78539816339744783_8
  lat(           1 ,           3 ) =    0.0000000000000000_8
  lon(           1 ,           3 ) =  -0.78539816339744828_8
  lat(           2 ,           3 ) =    0.0000000000000000_8
  lon(           2 ,           3 ) =  -0.39269908169872458_8
  lat(           3 ,           3 ) =    0.0000000000000000_8
  lon(           3 ,           3 ) =    0.0000000000000000_8
  lat(           4 ,           3 ) =    0.0000000000000000_8
  lon(           4 ,           3 ) =   0.39269908169872414_8
  lat(           5 ,           3 ) =    0.0000000000000000_8
  lon(           5 ,           3 ) =   0.78539816339744828_8
  lat(           1 ,           4 ) =   0.28492412662206240_8
  lon(           1 ,           4 ) =  -0.78539816339744739_8
  lat(           2 ,           4 ) =   0.36548975596819283_8
  lon(           2 ,           4 ) =  -0.39269908169872458_8
  lat(           3 ,           4 ) =   0.39269908169872420_8
  lon(           3 ,           4 ) =    0.0000000000000000_8
  lat(           4 ,           4 ) =   0.36548975596819283_8
  lon(           4 ,           4 ) =   0.39269908169872414_8
  lat(           5 ,           4 ) =   0.28492412662206240_8
  lon(           5 ,           4 ) =   0.78539816339744783_8
  lat(           1 ,           5 ) =   0.61547970867038726_8
  lon(           1 ,           5 ) =  -0.78539816339744828_8
  lat(           2 ,           5 ) =   0.74585266077307355_8
  lon(           2 ,           5 ) =  -0.39269908169872458_8
  lat(           3 ,           5 ) =   0.78539816339744817_8
  lon(           3 ,           5 ) =    0.0000000000000000_8
  lat(           4 ,           5 ) =   0.74585266077307355_8
  lon(           4 ,           5 ) =   0.39269908169872414_8
  lat(           5 ,           5 ) =   0.61547970867038726_8
  lon(           5 ,           5 ) =   0.78539816339744828_8

elseif (grid_type == 2 .and. npx == 4) then

  lat(           1 ,           1 ) =  -0.61547970867038726_8
  lon(           1 ,           1 ) =  -0.78539816339744828_8
  lat(           2 ,           1 ) =  -0.76806751857854005_8
  lon(           2 ,           1 ) =  -0.26179938779914913_8
  lat(           3 ,           1 ) =  -0.76806751857854005_8
  lon(           3 ,           1 ) =   0.26179938779914913_8
  lat(           4 ,           1 ) =  -0.61547970867038726_8
  lon(           4 ,           1 ) =   0.78539816339744828_8
  lat(           1 ,           2 ) =  -0.18724909954596927_8
  lon(           1 ,           2 ) =  -0.78539816339744828_8
  lat(           2 ,           2 ) =  -0.25326156345872919_8
  lon(           2 ,           2 ) =  -0.26179938779914913_8
  lat(           3 ,           2 ) =  -0.25326156345872919_8
  lon(           3 ,           2 ) =   0.26179938779914913_8
  lat(           4 ,           2 ) =  -0.18724909954596927_8
  lon(           4 ,           2 ) =   0.78539816339744828_8
  lat(           1 ,           3 ) =   0.18724909954596927_8
  lon(           1 ,           3 ) =  -0.78539816339744828_8
  lat(           2 ,           3 ) =   0.25326156345872919_8
  lon(           2 ,           3 ) =  -0.26179938779914913_8
  lat(           3 ,           3 ) =   0.25326156345872919_8
  lon(           3 ,           3 ) =   0.26179938779914913_8
  lat(           4 ,           3 ) =   0.18724909954596927_8
  lon(           4 ,           3 ) =   0.78539816339744828_8
  lat(           1 ,           4 ) =   0.61547970867038726_8
  lon(           1 ,           4 ) =  -0.78539816339744828_8
  lat(           2 ,           4 ) =   0.76806751857854005_8
  lon(           2 ,           4 ) =  -0.26179938779914913_8
  lat(           3 ,           4 ) =   0.76806751857854005_8
  lon(           3 ,           4 ) =   0.26179938779914913_8
  lat(           4 ,           4 ) =   0.61547970867038726_8
  lon(           4 ,           4 ) =   0.78539816339744828_8

endif

end subroutine get_ref

end program driver
